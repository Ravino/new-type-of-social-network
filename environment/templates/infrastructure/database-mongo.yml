AWSTemplateFormatVersion: '2010-09-09'
Description: MongoDB cluster.
Parameters:
  EnvironmentName:
    Type: String
    Default: test
    Description: The environment name, used for locating outputs from the
                 prerequisite stacks
  MongoDBMasterUsername:
    Type: String
    Default: 'plizi'
    Description: MongoDB admin user name.
  MongoDBMasterUserPassword:
    Type: String
    Default: 'Tksx2PPDba8Ny0lZ'
    NoEcho: true
    Description: MongoDB admin user password.
  DBInstanceClass:
    Type: String
    Default: db.r5.4xlarge 
Resources:

  MongoSubnetGroup:
    Type: "AWS::DocDB::DBSubnetGroup"
    Properties:
      DBSubnetGroupDescription: Mongo
      SubnetIds: !Split [',', {'Fn::ImportValue': !Join [':', [!Ref 'EnvironmentName', 'PrivateSubnets']] }]
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  MongoSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Mongo
      VpcId:
        Fn::ImportValue:
          !Join [':', [!Ref 'EnvironmentName', 'VPCId']]
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  MongoIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref 'MongoSecurityGroup'
      IpProtocol: tcp
      FromPort: 27017
      ToPort: 27017
      SourceSecurityGroupId:
        Fn::ImportValue:
          !Join [':', [!Ref 'EnvironmentName', 'FargateContainerSecurityGroup']]
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  MongoDBClusterParameterGroup:
    Type: AWS::DocDB::DBClusterParameterGroup
    Properties:
      Description: MongoDB cluster parameters group
      Family: "docdb3.6"
      Parameters:
        audit_logs: "enabled" # prod: disabled
        tls: "disabled" # prod: enabled
        ttl_monitor: "enabled"
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  MongoDBCluster:
    Type: 'AWS::DocDB::DBCluster'
    Properties:
        EngineVersion: "docdb3.6"
        DBClusterParameterGroupName: !Ref 'MongoDBClusterParameterGroup'
        DBSubnetGroupName: !Ref 'MongoSubnetGroup'
        AvailabilityZones:
          - eu-central-1a
          - eu-central-1b
          - eu-central-1c
        MasterUsername: !Ref 'MongoDBMasterUsername'
        MasterUserPassword: !Ref 'MongoDBMasterUserPassword'
        Port: 27017
        VpcSecurityGroupIds: !Ref 'MongoSecurityGroup'
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  MongoDBInstanceSubnetOne:
    Type: "AWS::DocDB::DBInstance"
    Properties:
      AvailabilityZones: eu-central-1a
      DBInstanceClass: !Ref DBInstanceClass
      DBClusterIdentifier: !Ref 'MongoDBCluster'
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
  
  MongoDBInstanceSubnetTwo:
    Type: "AWS::DocDB::DBInstance"
    Properties:
      AvailabilityZones: eu-central-1b
      DBInstanceClass: !Ref DBInstanceClass
      DBClusterIdentifier: !Ref 'MongoDBCluster'
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  MongoDBInstanceSubnetThree:
    Type: "AWS::DocDB::DBInstance"
    Properties:
      AvailabilityZones: eu-central-1c
      DBInstanceClass: !Ref DBInstanceClass
      DBClusterIdentifier: !Ref 'MongoDBCluster'
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
  
Outputs:
  MongoDBName:
    Value: 'admin'
    Export:
      Name: !Join [ ':', [ !Ref 'EnvironmentName', 'MongoDBName' ] ]
  MongoDBHost:
    Value: !GetAtt 'MongoDBCluster.Endpoint'
    Export:
      Name: !Join [ ':', [ !Ref 'EnvironmentName', 'MongoDBHost' ] ]
  MongoDBUser:
    Value: !Ref 'MongoDBMasterUsername'
    Export:
      Name: !Join [ ':', [ !Ref 'EnvironmentName', 'MongoDBUser' ] ]
  MongoDBPass:
    Value: !Ref 'MongoDBMasterUserPassword'
    Export:
      Name: !Join [ ':', [ !Ref 'EnvironmentName', 'MongoDBPass' ] ]
  MongoSecurityGroup:
    Value: !Ref 'MongoSecurityGroup'
    Export:
      Name: !Join [ ':', [ !Ref 'EnvironmentName', 'MongoSecurityGroup' ] ]